[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lead",
  "enabled": 1,
  "modified": "2025-08-29 23:41:11.146782",
  "module": "CRM",
  "name": "Filtered Buttons",
  "script": "// Override frappe.confirm globally to intercept Clear Assignment confirm dialog\n(function() {\n    const original_confirm = frappe.confirm;\n    frappe.confirm = function(message, on_yes, on_no) {\n        // Check if this is the Clear Assignment confirm dialog\n        if (message && (message.indexOf('clear the assignments') !== -1 || message.indexOf('clear the assignment') !== -1)) {\n            // Get current listview\n            const listview = cur_list || frappe.views.list_view;\n            if (!listview) {\n                return original_confirm.call(this, message, on_yes, on_no);\n            }\n            \n            // Get selected items\n            const selected = listview.get_checked_items ? listview.get_checked_items(true) : [];\n            if (selected.length === 0) {\n                frappe.msgprint(__('Please select at least one lead'));\n                return;\n            }\n            \n            // Open assignment dialog directly without confirm\n            open_assign_dialog_for_clear(listview, selected);\n            return;\n        }\n        // For other confirm dialogs, use original function\n        return original_confirm.call(this, message, on_yes, on_no);\n    };\n})();\n\nfrappe.listview_settings['CRM Lead'] = {\n    add_fields: ['original_lead', 'is_duplicate', 'status'],\n\n    get_indicator(doc) {\n        if (cint(doc.is_duplicate)) {\n            return [__('Duplicate'), 'yellow', 'is_duplicate,=,1'];\n        }\n        if (cint(doc.original_lead)) {\n            return [__('Original'), 'orange', 'original_lead,=,1'];\n        }\n    },\n\n    onload(listview) {\n        frappe.after_ajax(() => {\n            if (listview.page._crm_ui_ready) return;\n            listview.page._crm_ui_ready = true;\n\n            let activeBtn = null;\n\n            const styleBtn = ($btn, base, hover, active) => {\n                $btn.css({\n                    backgroundColor: base,\n                    color: 'white',\n                    fontWeight: 600,\n                    borderRadius: '6px',\n                    padding: '6px 12px',\n                    transition: 'all .2s ease-in-out',\n                    boxShadow: '0 2px 4px rgba(0,0,0,.1)',\n                    marginRight: '6px'\n                })\n                .hover(\n                    function(){ if (this !== activeBtn) $(this).css('background-color', hover); },\n                    function(){ if (this !== activeBtn) $(this).css('background-color', base); }\n                );\n            };\n\n            const markActive = ($btn, base, active) => {\n                if (activeBtn) {\n                    $(activeBtn).css({\n                        backgroundColor: $(activeBtn).data(\"base\"),\n                        boxShadow: '0 2px 4px rgba(0,0,0,.1)',\n                        transform: 'scale(1)'\n                    });\n                }\n                activeBtn = $btn[0];\n                $btn.css({\n                    backgroundColor: active,\n                    boxShadow: '0 4px 6px rgba(0,0,0,.15)',\n                    transform: 'scale(1.03)'\n                });\n            };\n\n            // Duplicate Leads button\n            const btnDuplicate = listview.page.add_inner_button(__('Duplicate Leads'), () => {\n                listview.filter_area.clear();\n                listview.filter_area.add([['CRM Lead', 'is_duplicate', '=', 1]]);\n                listview.run();\n                markActive(btnDuplicate, '#FF6B35', '#cc4c24');\n            });\n            btnDuplicate.data(\"base\", \"#FF6B35\");\n            styleBtn(btnDuplicate, '#FF6B35', '#e85c2b', '#cc4c24');\n\n            // Parent Leads button\n            const btnParent = listview.page.add_inner_button(__('Original Leads'), () => {\n                listview.filter_area.clear();\n                listview.filter_area.add([['CRM Lead', 'original_lead', '=', 1]]);\n                listview.run();\n                markActive(btnParent, '#1E3A8A', '#0f1e4f');\n            });\n            btnParent.data(\"base\", \"#1E3A8A\");\n            styleBtn(btnParent, '#1E3A8A', '#162c6a', '#0f1e4f');\n\n            // Without Duplicates button\n            const btnWithout = listview.page.add_inner_button(__('Without Duplicates'), () => {\n                listview.filter_area.clear();\n                listview.filter_area.add([['CRM Lead', 'is_duplicate', '!=', 1]]);\n                listview.run();\n                markActive(btnWithout, '#334155', '#111827');\n            });\n            btnWithout.data(\"base\", \"#334155\");\n            styleBtn(btnWithout, '#334155', '#1f2937', '#111827');\n\n            // âœ… Trigger \"Without Duplicates\" by default\n            btnWithout.trigger(\"click\");\n        });\n    },\n    \n    // Override get_actions to customize Clear Assignment\n    get_actions: function() {\n        const listview = cur_list;\n        return [\n            {\n                label: __('Clear Assignment'),\n                action: function() {\n                    const selected = listview.get_checked_items(true);\n                    if (selected.length === 0) {\n                        frappe.msgprint(__('Please select at least one lead'));\n                        return;\n                    }\n                    // Open assignment dialog directly without confirm\n                    open_assign_dialog_for_clear(listview, selected);\n                }\n            }\n        ];\n    }\n};\n\nfunction open_assign_dialog_for_clear(listview, selected_items) {\n    // Get assignable users\n    frappe.call({\n        method: 'crm.fcrm.permissions.assign_to.get_assignable_users',\n        args: {\n            doctype: 'Lead',\n            name: selected_items[0]?.name || ''\n        },\n        callback: function(r) {\n            const assignable_users = (r.message || []).map(u => u.name || u);\n            \n            // Create assignment dialog\n            const d = new frappe.ui.Dialog({\n                title: __('Assign To'),\n                fields: [\n                    {\n                        label: __('Assign To'),\n                        fieldname: 'assign_to',\n                        fieldtype: 'MultiSelectPills',\n                        get_data: function(txt) {\n                            if (!txt) return [];\n                            return frappe.db.get_list('User', {\n                                filters: assignable_users.length ? {\n                                    'name': ['in', assignable_users]\n                                } : {},\n                                limit: 20,\n                                or_filters: [\n                                    ['full_name', 'like', '%' + txt + '%'],\n                                    ['name', 'like', '%' + txt + '%']\n                                ]\n                            }).then(users => {\n                                return users.map(u => ({\n                                    value: u.name,\n                                    description: u.full_name || u.name\n                                }));\n                            });\n                        }\n                    }\n                ],\n                primary_action_label: __('Update'),\n                primary_action: function(values) {\n                    const assignees = values.assign_to || [];\n                    // Filter out undefined/null names and ensure we have valid document names\n                    const names = selected_items\n                        .map(item => item.name || item)\n                        .filter(name => name && (typeof name === 'string' ? name.trim() !== '' : true));\n                    \n                    if (names.length === 0) {\n                        frappe.msgprint(__('No valid document names found in selected items'));\n                        return;\n                    }\n                    \n                    // Clear existing assignments first, then assign new ones\n                    frappe.call({\n                        method: 'crm.api.doc.remove_multiple_assignments',\n                        args: {\n                            doctype: 'Lead',\n                            names: names,\n                            ignore_permissions: true\n                        },\n                        callback: function() {\n                            if (assignees.length > 0) {\n                                // Use assign_without_rule for bulk assignment to bypass assignment rules\n                                const validNames = names.filter(name => name && (typeof name === 'string' ? name.trim() !== '' : true));\n                                \n                                if (validNames.length === 0) {\n                                    frappe.msgprint(__('No valid document names found'));\n                                    return;\n                                }\n                                \n                                frappe.call({\n                                    method: 'crm.api.doc.assign_without_rule',\n                                    args: {\n                                        doctype: 'Lead',\n                                        assign_to: assignees,\n                                        names: validNames,\n                                        description: ''\n                                    },\n                                    callback: function(r) {\n                                        if (r.exc) {\n                                            frappe.msgprint(__('Error assigning: {0}', [r.exc]));\n                                            return;\n                                        }\n                                        d.hide();\n                                        frappe.show_alert({\n                                            message: __('Assigned successfully'),\n                                            indicator: 'green'\n                                        });\n                                        listview.refresh();\n                                    }\n                                });\n                            } else {\n                                d.hide();\n                                frappe.show_alert({\n                                    message: __('Assignment cleared successfully'),\n                                    indicator: 'green'\n                                });\n                                listview.refresh();\n                            }\n                        }\n                    });\n                }\n            });\n            \n            d.show();\n        }\n    });\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lead",
  "enabled": 1,
  "modified": "2025-08-04 13:16:59.867962",
  "module": "CRM",
  "name": "Highlight Orginal lead has Duplicates",
  "script": "frappe.ui.form.on('CRM Lead', {\n  refresh(frm) {\n\n    if (frm.dashboard && frm.dashboard.wrapper) {\n      frm.dashboard.wrapper.find('.indicator').remove();\n    }\n\n    if (frm.doc.original_lead == 1) {\n      frm.dashboard.add_indicator(__('Has Duplicates'), 'orange');\n    }\n  }\n});",
  "view": "List"
 }
]