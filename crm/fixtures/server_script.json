[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-25 15:57:42.544818",
  "module": "FCRM",
  "name": "Hot Leads",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "CRM Lead",
  "script": "# =========================\n# PUBLIC CONFIG (Editable)\n# =========================\n\nCONFIG = {\n    # وزن كل محور (لازم مجموعهم = 100 عشان نحافظ على 0..100)\n    \"WEIGHTS\": {\n        \"status\": 45,\n        \"last_contacted\": 20,\n        \"tasks\": 15,\n        \"notes\": 10,\n        \"lead_age\": 10,\n    },\n\n    # خريطة نقاط الحالة (0..WEIGHTS['status'])\n    # عدّلي الأسماء زي ما عندك في \"CRM Lead Status\" وادّي لكل واحدة Score مناسب.\n    # الأسماء الحالية بناءً على الصورة المرفقة:\n    \"STATUS_POINTS\": {\n        \"Made A Reservation\": 45,\n        \"Qualified\": 40,\n        \"Follow Up After Meeting\": 35,\n        \"Follow Up Meeting\": 30,\n        \"Meeting\": 30,\n        \"Follow Up\": 20,\n        \"Rotation\": 15,\n        \"New\": 10,\n        \"No Answer\": 5,\n        \"Not Interested\": 0,\n        # لو عندك حالات إضافية، زوديها هنا\n        # \"Property Visit\": 38,\n        # \"Office Visit\": 34,\n        # \"Contacted\": 18,\n        # \"Unqualified\": 0,\n        # \"Junk\": 0,\n    },\n\n    # تقسيم التصنيف النهائي\n    \"RANK_THRESHOLDS\": {\n        \"Hot\": 70,\n        \"Warm\": 40,   # من 40 إلى أقل من 70\n        \"Cold\": 0,    # أقل من 40\n    },\n\n    # إعدادات زمنية\n    \"RECENT_NOTE_DAYS\": 14,\n    \"RECENT_DONE_TASK_DAYS\": 14,\n}\n\n# ================\n# Helper Functions\n# ================\n\ndef clamp(value, lo, hi):\n    try:\n        if value < lo:\n            return lo\n        if value > hi:\n            return hi\n        return value\n    except Exception:\n        return lo\n\ndef get_status_score(doc, weights, status_points):\n    # لو الحالة مش موجودة في الخريطة نديها 50% من وزن الحالة كتقدير افتراضي\n    base = status_points.get(doc.status, int(weights[\"status\"] * 0.5))\n    base = clamp(base, 0, weights[\"status\"])\n    reason = f\"Status={doc.status} => {base}\"\n    return base, reason\n\ndef get_last_contacted_score(doc, weights):\n    w = weights[\"last_contacted\"]\n    pts = 0\n    lc = doc.last_contacted\n\n    if lc:\n        days = frappe.utils.date_diff(frappe.utils.today(), lc)\n        # 0..w على سلالم واضحة\n        if days <= 2:\n            pts = w\n        elif days <= 7:\n            pts = int(w * 0.8)   # 16/20\n        elif days <= 14:\n            pts = int(w * 0.6)   # 12/20\n        elif days <= 30:\n            pts = int(w * 0.4)   # 8/20\n        elif days <= 60:\n            pts = int(w * 0.2)   # 4/20\n        else:\n            pts = 0\n        reason = f\"LastContacted={lc} (days={days}) => {pts}\"\n    else:\n        pts = 0\n        reason = \"LastContacted=None => 0\"\n\n    return clamp(pts, 0, w), reason\n\ndef get_tasks_score(doc, weights, cfg):\n    w = weights[\"tasks\"]\n    open_bonus = 0\n    overdue_penalty = 0\n    recent_done_bonus = 0\n    reasons = []\n\n    leadname = doc.name\n    is_provisional = False\n    try:\n        is_provisional = (isinstance(leadname, str) and leadname.startswith(\"new-\"))\n    except Exception:\n        is_provisional = True\n\n    if not leadname or is_provisional:\n        return 0, \"Tasks=provisional/none => 0\"\n\n    # نحاول \"CRM Task\" أولاً، ثم fallback إلى \"ToDo\"\n    OPEN_STATUSES = {\"Backlog\", \"Todo\", \"In Progress\"}\n    CLOSED_STATUSES = {\"Done\", \"Canceled\"}\n\n    recent_days = cfg[\"RECENT_DONE_TASK_DAYS\"]\n    today = frappe.utils.today()\n    recent_cut = frappe.utils.add_days(today, -recent_days)\n\n    # --- Try CRM Task ---\n    try:\n        open_tasks = frappe.db.count(\n            \"CRM Task\",\n            filters={\n                \"reference_doctype\": \"CRM Lead\",\n                \"reference_docname\": leadname,\n                \"status\": [\"in\", list(OPEN_STATUSES)],\n            },\n        )\n\n        overdue_open = 0\n        try:\n            overdue_open = frappe.db.count(\n                \"CRM Task\",\n                filters={\n                    \"reference_doctype\": \"CRM Lead\",\n                    \"reference_docname\": leadname,\n                    \"status\": [\"in\", list(OPEN_STATUSES)],\n                    \"due_date\": [\"<\", today],\n                },\n            )\n        except Exception:\n            overdue_open = 0\n\n        recent_done = 0\n        try:\n            recent_done = frappe.db.count(\n                \"CRM Task\",\n                filters={\n                    \"reference_doctype\": \"CRM Lead\",\n                    \"reference_docname\": leadname,\n                    \"status\": \"Done\",\n                    \"modified\": [\">=\", recent_cut],\n                },\n            )\n        except Exception:\n            recent_done = 0\n\n    except Exception:\n        # --- Fallback ToDo ---\n        try:\n            open_tasks = frappe.db.count(\n                \"ToDo\",\n                filters={\n                    \"reference_type\": \"CRM Lead\",\n                    \"reference_name\": leadname,\n                    \"status\": [\"!=\", \"Closed\"],\n                },\n            )\n            overdue_open = 0\n            try:\n                overdue_open = frappe.db.count(\n                    \"ToDo\",\n                    filters={\n                        \"reference_type\": \"CRM Lead\",\n                        \"reference_name\": leadname,\n                        \"status\": [\"!=\", \"Closed\"],\n                        \"date\": [\"<\", today],\n                    },\n                )\n            except Exception:\n                overdue_open = 0\n\n            recent_done = 0  # ToDo مفيهوش \"Done\" بنفس الطريقة\n        except Exception:\n            open_tasks = 0\n            overdue_open = 0\n            recent_done = 0\n\n    # توزيع النقاط داخل وزن الـ tasks (15):\n    # - وجود مهام مفتوحة (نشِطة): +10 كحد أقصى\n    # - متأخرات: −5 لكل مهمة (حد أقصى −10) لكن منغيرش المجموع عن 0\n    # - مهام اتقفلت حديثًا: +2 لكل واحدة (حد أقصى +5)\n    open_bonus = 10 if open_tasks >= 1 else 0\n    overdue_penalty = (-5) * min(2, overdue_open)\n    recent_done_bonus = min(5, recent_done * 2)\n\n    subtotal = open_bonus + overdue_penalty + recent_done_bonus\n    subtotal = clamp(subtotal, 0, w)\n\n    reasons.append(f\"Open={open_tasks}(+{open_bonus})\")\n    reasons.append(f\"Overdue={overdue_open}({overdue_penalty})\")\n    reasons.append(f\"RecentDone={recent_done}(+{recent_done_bonus})\")\n\n    return subtotal, \"Tasks[\" + \", \".join(reasons) + f\"] => {subtotal}\"\n\ndef get_notes_score(doc, weights, cfg):\n    w = weights[\"notes\"]\n    total_notes = 0\n    recent_notes = 0\n    leadname = doc.name\n    is_provisional = False\n    try:\n        is_provisional = (isinstance(leadname, str) and leadname.startswith(\"new-\"))\n    except Exception:\n        is_provisional = True\n\n    if leadname and (not is_provisional):\n        try:\n            total_notes = frappe.db.count(\n                \"FCRM Note\",\n                filters={\n                    \"reference_doctype\": \"CRM Lead\",\n                    \"reference_docname\": leadname,\n                },\n            )\n        except Exception:\n            total_notes = 0\n\n        try:\n            recent_notes = frappe.db.count(\n                \"FCRM Note\",\n                filters={\n                    \"reference_doctype\": \"CRM Lead\",\n                    \"reference_docname\": leadname,\n                    \"creation\": [\">=\", frappe.utils.add_days(frappe.utils.today(), -cfg[\"RECENT_NOTE_DAYS\"])],\n                },\n            )\n        except Exception:\n            recent_notes = 0\n\n    # تحويل إلى نقاط داخل وزن الـ notes (10):\n    # +2 لكل Note لحد 3 نوتس (6 نقاط)، +4 بونص لو في نشاط حديث\n    points_from_total = min(3, int(total_notes)) * 2          # 0..6\n    recent_bonus = 4 if recent_notes > 0 else 0               # 0 أو 4\n    subtotal = clamp(points_from_total + recent_bonus, 0, w)\n    reason = f\"Notes(Total={total_notes}, Recent={recent_notes}) => {subtotal}\"\n    return subtotal, reason\n\ndef get_lead_age_score(doc, weights):\n    w = weights[\"lead_age\"]\n    created = doc.get(\"creation\")\n    if not created:\n        return 0, \"LeadAge=None => 0\"\n    days = frappe.utils.date_diff(frappe.utils.today(), created)\n    # جديد جدًا = نقاط أعلى\n    if days <= 7:\n        pts = w\n    elif days <= 30:\n        pts = int(w * 0.7)   # 7/10\n    elif days <= 60:\n        pts = int(w * 0.4)   # 4/10\n    elif days <= 120:\n        pts = int(w * 0.2)   # 2/10\n    else:\n        pts = 0\n    return clamp(pts, 0, w), f\"LeadAge(days={days}) => {pts}\"\n\ndef rank_from_score(score, thresholds):\n    if score >= thresholds[\"Hot\"]:\n        return \"Hot\"\n    if score >= thresholds[\"Warm\"]:\n        return \"Warm\"\n    return \"Cold\"\n\n# ========================\n# Main: compute lead score\n# ========================\n\ndef before_save(doc, method=None):\n    weights = CONFIG[\"WEIGHTS\"]\n    status_points = CONFIG[\"STATUS_POINTS\"]\n    thresholds = CONFIG[\"RANK_THRESHOLDS\"]\n\n    reasons = []\n    total = 0\n\n    # 1) Status\n    s_pts, s_reason = get_status_score(doc, weights, status_points)\n    total = total + s_pts\n    reasons.append(s_reason)\n\n    # 2) Last Contacted\n    lc_pts, lc_reason = get_last_contacted_score(doc, weights)\n    total = total + lc_pts\n    reasons.append(lc_reason)\n\n    # 3) Tasks\n    t_pts, t_reason = get_tasks_score(doc, weights, CONFIG)\n    total = total + t_pts\n    reasons.append(t_reason)\n\n    # 4) Notes\n    n_pts, n_reason = get_notes_score(doc, weights, CONFIG)\n    total = total + n_pts\n    reasons.append(n_reason)\n\n    # 5) Lead Age\n    a_pts, a_reason = get_lead_age_score(doc, weights)\n    total = total + a_pts\n    reasons.append(a_reason)\n\n    # Clamp 0..100\n    total = clamp(total, 0, 100)\n\n    # Set fields\n    doc.lead_score = int(total)\n    doc.lead_rating = rank_from_score(int(total), thresholds)\n    doc.rating_reason = \" | \".join(reasons) + f\" => Total {int(total)}\"\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-21 01:43:24.776205",
  "module": "FCRM",
  "name": "FCRM Note For Hot Leads",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "CRM Note",
  "script": "# Recompute lead score when any FCRM Note linked to a Lead is saved\ntry:\n    if doc.reference_doctype == \"CRM Lead\" and doc.reference_docname:\n        lead = frappe.get_doc(\"CRM Lead\", doc.reference_docname)\n        lead.save()  # triggers your Lead before_save script\nexcept Exception as e:\n    frappe.log_error(\"FCRM Note trigger failed: \" + str(e), \"Lead Rescore\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-21 01:43:15.812876",
  "module": "FCRM",
  "name": "ToDo For Hot Leads",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "ToDo",
  "script": "# Recompute lead score when a ToDo linked to a Lead is saved\ntry:\n    if doc.reference_type == \"CRM Lead\" and doc.reference_name:\n        lead = frappe.get_doc(\"CRM Lead\", doc.reference_name)\n        lead.save()\nexcept Exception as e:\n    frappe.log_error(\"ToDo trigger failed: \" + str(e), \"Lead Rescore\")\n",
  "script_type": "DocType Event"
 }
]