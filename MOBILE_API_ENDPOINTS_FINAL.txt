â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   CRM MOBILE API - CALLABLE ENDPOINTS                        â•‘
â•‘                         All Fixes Applied âœ…                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BASE URL: https://your-site.com/api/method/crm.api.mobile_api

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ ENDPOINT LIST (7 Total)

POST   /api/method/crm.api.mobile_api.create_task        
       â”œâ”€ Required: task_type (Meeting|Property Showing|Call)
       â”œâ”€ Optional: title, status, priority, start_date, description, assigned_to, due_date
       â””â”€ Returns: Compact task JSON

POST   /api/method/crm.api.mobile_api.edit_task          
       â”œâ”€ Required: name
       â”œâ”€ Optional: title, status, priority, start_date, task_type, description, assigned_to, due_date
       â””â”€ Returns: Updated compact task JSON

POST   /api/method/crm.api.mobile_api.delete_task        
       â”œâ”€ Required: name
       â””â”€ Returns: {"ok": true}

POST   /api/method/crm.api.mobile_api.update_status      
       â”œâ”€ Required: name, status
       â””â”€ Returns: Updated compact task JSON

GET    /api/method/crm.api.mobile_api.filter_tasks       
       â”œâ”€ Optional: date_from, date_to, importance, status, limit, offset, order_by
       â”œâ”€ âœ… FIX: Now uses list-based filters (both date_from AND date_to apply)
       â””â”€ Returns: {"data": [...]}

GET    /api/method/crm.api.mobile_api.home_tasks         
       â”œâ”€ Optional: limit (default: 5)
       â””â”€ Returns: {"today": [...], "limit": N}

GET    /api/method/crm.api.mobile_api.main_page_buckets  
       â”œâ”€ Optional: min_each (default: 5)
       â””â”€ Returns: {"today": [...], "late": [...], "upcoming": [...], "min_each": N}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” AUTHENTICATION

All endpoints require:
  â€¢ Standard Frappe session authentication
  â€¢ Login at: POST /api/method/login
  â€¢ Include session cookies in all requests
  â€¢ Required roles: Sales User OR Sales Manager

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¦ RESPONSE FORMAT (Compact & Consistent)

Core fields (always included):
  â€¢ name          - Task ID
  â€¢ title         - Task title (or derived from description)
  â€¢ status        - Task status
  â€¢ priority      - Task priority (Low/Medium/High)
  â€¢ start_date    - Task start date (YYYY-MM-DD)
  â€¢ modified      - Last modified timestamp

Optional fields (included if present on doctype):
  â€¢ due_date      - Due date/time (YYYY-MM-DD HH:MM:SS)
  â€¢ assigned_to   - Assigned user email

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… FIXES APPLIED

1. Whitelist Decorators âœ…
   â€¢ All endpoints: @frappe.whitelist(allow_guest=False, methods=[...])
   â€¢ POST methods: create_task, edit_task, delete_task, update_status
   â€¢ GET methods: filter_tasks, home_tasks, main_page_buckets

2. Filter Logic Fixed âœ…
   â€¢ filter_tasks() now uses LIST of conditions (not dict)
   â€¢ Both date_from AND date_to now apply correctly
   â€¢ Example: ?date_from=2025-12-01&date_to=2025-12-31 (both work!)

3. Field Safety âœ…
   â€¢ Added _safe_fields() helper function
   â€¢ Only queries fields that exist on CRM Task doctype
   â€¢ No more KeyErrors for missing fields (assigned_to, due_date)

4. Response Consistency âœ…
   â€¢ Core fields always included
   â€¢ Optional fields added only if present
   â€¢ Safe field access using .get() and hasattr()

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ§ª QUICK TEST COMMANDS

# Login and save cookies
curl -X POST https://trust.jossoor.org/api/method/login \
  -d "usr=admin@example.com&pwd=password" \
  -c cookies.txt

# Test home tasks (should return 200 with compact tasks)
curl -s "https://trust.jossoor.org/api/method/crm.api.mobile_api.home_tasks?limit=5" \
  -b cookies.txt | jq .

# Test filter with date range (both dates should apply)
curl -s "https://trust.jossoor.org/api/method/crm.api.mobile_api.filter_tasks?date_from=2025-12-01&date_to=2025-12-31&limit=10" \
  -b cookies.txt | jq .

# Test filter with multiple parameters
curl -s "https://trust.jossoor.org/api/method/crm.api.mobile_api.filter_tasks?date_from=2025-12-01&importance=High,Medium&status=Todo,In%20Progress&limit=20" \
  -b cookies.txt | jq .

# Test main page buckets
curl -s "https://trust.jossoor.org/api/method/crm.api.mobile_api.main_page_buckets?min_each=5" \
  -b cookies.txt | jq .

# Create a task
curl -X POST "https://trust.jossoor.org/api/method/crm.api.mobile_api.create_task" \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{"task_type":"Call","title":"Test Task","priority":"High","status":"Todo"}'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š STATUS SUMMARY

âœ… All endpoints properly whitelisted
âœ… Filter logic fixed (list-based filters)
âœ… Field safety implemented (_safe_fields helper)
âœ… Response format consistent
âœ… No linter errors
âœ… Ready for production testing

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“– DOCUMENTATION

For complete documentation, see:
  â€¢ MOBILE_API_README.md - Main documentation
  â€¢ API_ENDPOINTS.md - Detailed endpoint reference
  â€¢ MOBILE_API_FIXES_APPLIED.md - Complete list of fixes
  â€¢ MOBILE_API_QUICK_REFERENCE.md - Quick reference card

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Version: 1.1 (Fixed)
Date: December 3, 2025
Status: READY âœ…

