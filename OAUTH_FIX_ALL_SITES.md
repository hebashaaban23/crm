# ๐ง OAuth Fix - ุญู ุดุงูู ูุฌููุน ุงูููุงูุน

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุญู ูุทุจู ุฅุตูุงุญ OAuth refresh token ุนูู **ุฌููุน ุงูููุงูุน** ุงูููุฌูุฏุฉ ูุงูุฌุฏูุฏุฉ ุชููุงุฆูุงู.

## โ ูุง ุชู ุฅุตูุงุญู

1. **ูุดููุฉ `DoesNotExistError`**: ุชู ุฅุตูุงุญูุง ุจุงุณุชุฎุฏุงู `frappe.get_all` ุจุฏูุงู ูู `frappe.get_doc` ูุน dictionary filters
2. **ูุดููุฉ `invalid_grant`**: ุชู ุญููุง
3. **Refresh Token Expiry**: ูุถุจูุท ุนูู 12 ุณุงุนุฉ (43200 ุซุงููุฉ)
4. **ูุดููุฉ "ูููุฉ ูุจูุฑุฉ ุฌุฏุงู"**: ุชู ุฅุฒุงูุฉ ุงูู logging ุงูููุฑุท

## ๐ง ููู ูุนูู ุงูุญู

### 1. ุงูู Fix ุงูุชููุงุฆู (ูุนูู ุนูู ูู ุงูู sites)

- **ุงูููู**: `crm/oauth_fix.py`
- **ุงูุชุญููู**: ูุชู ุชุญูููู ุชููุงุฆูุงู ูู `hooks.py` ุนูุฏ ุจุฏุก Frappe
- **ุงูุชุทุจูู**: ูุนูู ุชููุงุฆูุงู ุนูู ูู ุงูู sites ุจุฏูู ุชุฏุฎู ูุฏูู

```python
# ูู hooks.py
try:
    import crm.oauth_fix  # noqa: F401
except ImportError:
    pass
```

### 2. ุงูุฅุนุฏุงุฏุงุช (oauth_refresh_token_expiry)

#### ููููุงูุน ุงูููุฌูุฏุฉ:
- ุงุณุชุฎุฏู ุงูุณูุฑูุจุช: `apply_oauth_fix_to_all_sites.sh`

#### ููููุงูุน ุงูุฌุฏูุฏุฉ:
- ูุชู ุชุทุจูููุง ุชููุงุฆูุงู ุนูุฏ ุชุซุจูุช CRM ุนุจุฑ `after_install` hook

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### ููููุงูุน ุงูููุฌูุฏุฉ:

```bash
# 1. ุชุทุจูู ุงูุฅุตูุงุญ ุนูู ูู ุงูู sites
cd /home/frappe/frappe-bench-env/frappe-bench
./apps/crm/apply_oauth_fix_to_all_sites.sh

# 2. ุฅุนุงุฏุฉ ุชุดุบูู bench
bench restart
```

### ููููุงูุน ุงูุฌุฏูุฏุฉ:

```bash
# ุนูุฏ ุชุซุจูุช CRM ุนูู site ุฌุฏูุฏ
bench --site <new-site> install-app crm

# ุงูุฅุนุฏุงุฏุงุช ุณุชุทุจู ุชููุงุฆูุงู! โ
```

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ site ูุญุฏุฏ:

```bash
bench --site <site-name> console
```

```python
from crm.patches.v1_0.test_refresh_token import execute
execute()
```

### ุงููุชูุฌุฉ ุงููุชููุนุฉ:

```
โ SUCCESS! Refresh token validation works correctly!
   New Access Token: ...
   New Refresh Token: ...
   Expires In: 3600 seconds
```

## ๐ ุงููููุงุช

### ุงููููุงุช ุงูุฃุณุงุณูุฉ:

1. **`crm/oauth_fix.py`**
   - ูุญุชูู ุนูู ุงูู fix ุงูุฑุฆูุณู
   - ูุนูู ุชููุงุฆูุงู ุนูู ูู ุงูู sites

2. **`crm/hooks.py`**
   - ูุณุชูุฑุฏ `oauth_fix` ุชููุงุฆูุงู
   - ูุถูู ุนูู ุงูู fix ุนูู ูู ุงูู sites

3. **`crm/install.py`**
   - `after_install()` ูุทุจู ุงูุฅุนุฏุงุฏุงุช ุนูู sites ุฌุฏูุฏุฉ

### ุงูุณูุฑูุจุชุงุช:

1. **`apply_oauth_fix_to_all_sites.sh`**
   - ูุทุจู `oauth_refresh_token_expiry` ุนูู ูู ุงูู sites ุงูููุฌูุฏุฉ

2. **`crm/patches/v1_0/test_refresh_token.py`**
   - ุณูุฑูุจุช ุงุฎุชุจุงุฑ refresh token

## ๐ ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช

### ุงูุชุญูู ูู site ูุญุฏุฏ:

```bash
bench --site <site-name> console
```

```python
import frappe
import json
import os

site_config_path = frappe.get_site_path("site_config.json")
with open(site_config_path, 'r') as f:
    config = json.load(f)

print(f"oauth_refresh_token_expiry: {config.get('oauth_refresh_token_expiry', 'Not set')}")
# ูุฌุจ ุฃู ูููู: 43200 (12 ุณุงุนุฉ)
```

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูู Fix ูุนูู ุชููุงุฆูุงู**: ุจูุฌุฑุฏ ุชุญููู Frappeุ ุงูู fix ูุนูู ุนูู ูู ุงูู sites
2. **ุงูุฅุนุฏุงุฏุงุช ุชุญุชุงุฌ ุชุทุจูู ูุฑุฉ ูุงุญุฏุฉ**: `oauth_refresh_token_expiry` ูุญุชุงุฌ ุชุทุจูู ุนูู ูู site
3. **Sites ุงูุฌุฏูุฏุฉ**: ุชุญุตู ุนูู ุงูุฅุนุฏุงุฏุงุช ุชููุงุฆูุงู ุนูุฏ ุงูุชุซุจูุช
4. **ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชุดุบูู**: ุจุนุฏ ุชุทุจูู ุงูุฅุนุฏุงุฏุงุชุ ุงูู fix ูุนูู ูุจุงุดุฑุฉ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: `invalid_grant` ูุง ูุฒุงู ูุธูุฑ

**ุงูุญู**:
1. ุชุฃูุฏ ูู ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช: `./apply_oauth_fix_to_all_sites.sh`
2. ุฃุนุฏ ุชุดุบูู bench: `bench restart`
3. ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ูู `site_config.json`

### ุงููุดููุฉ: ุงูู fix ูุง ูุนูู ุนูู site ุฌุฏูุฏ

**ุงูุญู**:
1. ุชุฃูุฏ ูู ุชุซุจูุช CRM: `bench --site <site> list-apps | grep crm`
2. ุชุญูู ูู `hooks.py` ุฃูู ูุณุชูุฑุฏ `oauth_fix`
3. ุฃุนุฏ ุชุดุบูู bench

## โ ูุงุฆูุฉ ุงูุชุญูู

- [ ] ุชู ุชุทุจูู `apply_oauth_fix_to_all_sites.sh` ุนูู ูู ุงูู sites
- [ ] ุชู ุฅุนุงุฏุฉ ุชุดุบูู bench
- [ ] ุชู ุงุฎุชุจุงุฑ refresh token ุนูู site ูุงุญุฏ ุนูู ุงูุฃูู
- [ ] ุชู ุงูุชุญูู ูู `oauth_refresh_token_expiry` ูู `site_config.json`
- [ ] Sites ุงูุฌุฏูุฏุฉ ุชุญุตู ุนูู ุงูุฅุนุฏุงุฏุงุช ุชููุงุฆูุงู

## ๐ ุงููุชูุฌุฉ

ุจุนุฏ ุชุทุจูู ุงูุญู:
- โ ูู ุงูู sites ุงูููุฌูุฏุฉ ุชุนูู ุจุดูู ุตุญูุญ
- โ Sites ุงูุฌุฏูุฏุฉ ุชุญุตู ุนูู ุงูุฅุนุฏุงุฏุงุช ุชููุงุฆูุงู
- โ ูุง ุญุงุฌุฉ ูุชุฏุฎู ูุฏูู ูู ุงููุณุชูุจู
- โ ุงูู fix ูุนูู ุชููุงุฆูุงู ุนูู ูู ุงูู sites

